"use strict";var _a,_b,_c,_d,_e,_f,__awaiter=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))(function(i,o){function s(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,r)}c((a=a.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,a,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function r(o){return function(r){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,a&&(i=2&o[0]?a.return:o[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,o[1])).done)return i;switch(a=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,a=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],a=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,r])}}};Object.defineProperty(exports,"__esModule",{value:!0}),require("regenerator-runtime/runtime");var ezshop,modal_1=require("./templates/style/modal"),fullscreen_1=require("./templates/style/fullscreen"),box_1=require("./templates/style/box"),drawer_1=require("./templates/style/drawer"),domain=window.location.href,parts=domain.split(".");parts.length<=2?ezshop=domain.includes("myshopify.com")?null===(_a=domain.split("https://").pop())||void 0===_a?void 0:_a.split("/")[0]:(null===(_b=domain.split("https://").pop())||void 0===_b?void 0:_b.split(".")[0])+".myshopify.com":3===parts.length?ezshop=domain.includes("myshopify.com")?null===(_c=domain.split("https://").pop())||void 0===_c?void 0:_c.split("/")[0]:(null===(_d=domain.split("https://").pop())||void 0===_d?void 0:_d.split(".")[1])+".myshopify.com":parts.length>3&&(ezshop=domain.includes("myshopify.com")?(null===(_e=domain.split("https://").pop())||void 0===_e?void 0:_e.split(".")[1])+".myshopify.com":(null===(_f=domain.split("https://").pop())||void 0===_f?void 0:_f.split(".")[1])+".myshopify.com");var fetchCampaignInfo=function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("https://easypop.herokuapp.com/api/campaigns/"+ezshop,{method:"GET",headers:{"Content-Type":"application/json"}})];case 1:return[4,e.sent().json()];case 2:return[2,e.sent().data]}})})},fetchCartInfo=function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("/cart.js",{method:"GET",headers:{"Content-Type":"application/json"}})];case 1:return[4,e.sent().json()];case 2:return[2,e.sent()]}})})},ClassWatcher=function(){function e(e,t,n,a){var i=this;this.mutationCallback=function(e){for(var t=0,n=e;t<n.length;t++){var a=n[t];if("attributes"===a.type&&"class"===a.attributeName){var o=a.target.classList.contains(i.classToWatch);i.lastClassState!==o&&(i.lastClassState=o,o?i.classAddedCallback():i.classRemovedCallback())}}},this.targetNode=e,this.classToWatch=t,this.classAddedCallback=n,this.classRemovedCallback=a,this.observer=null,this.lastClassState=e.classList.contains(this.classToWatch),this.init()}return e.prototype.init=function(){this.observer=new MutationObserver(this.mutationCallback),this.observe()},e.prototype.observe=function(){this.observer.observe(this.targetNode,{attributes:!0})},e.prototype.disconnect=function(){this.observer.disconnect()},e}();function campaignInfo(){return __awaiter(this,void 0,void 0,function(){var e,t,n;return __generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,3,,4]),[4,fetchCampaignInfo()];case 1:return e=a.sent(),[4,fetchCartInfo()];case 2:return t=a.sent(),console.log(t),e.forEach(function(e){console.log(e);var n=e.freePlan,a=e.activated,i=e.style,o=e.content,s=e.settings,r=e._id,c=e.createdAt,l=s.triggers,d=s.triggerMatch;if(a){console.log("Easypop script activated");if(function(){if(console.log("Checking dates"),null==Date.parse((new Date).toString())){console.log("Datejs dates used");var e=Date.today(),t=new Date(s.selectedDates),n=new Date(s.selectedEndDates);if(-1!=Date.compare(e,t)&&(!s.endTiming||-1===Date.compare(e,n)))return!0}else{console.log("Normal dates used"),e=Date.parse((new Date).toString());var a=Date.parse(s.selectedDates);if(n=Date.parse(s.selectedEndDates),e>a&&(!s.endTiming||s.endTiming&&e<n))return!0}}()){var u=document.querySelector("body"),m=document.createElement("section"),p=document.createElement("link");p.rel="stylesheet",p.href="https://cdn.jsdelivr.net/gh/DrJulik/scripts@1.3/styles.min.css",document.head.appendChild(p);var f=function(){function e(){console.log("productfeedset");var e=e||{};e.productfeed={fetch:function(e,t,n,a,i,o){fetch(t,{method:e,headers:{"Content-Type":a,Accept:a,"X-Requested-With":"xmlhttprequest"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){i(e)}).catch(function(e){o(e)})},init:function(){function t(e){e.classList.contains("ezy-btn--loading")?(e.classList.remove("ezy-btn--loading"),e.disabled=!1):(e.classList.add("ezy-btn--loading"),e.disabled=!0)}var n=document.getElementsByClassName("js:ezy-scrollArrowButtons");Array.from(n).forEach(function(e){e.addEventListener("click",function(e){var t=this.getAttribute("data-scroll-container"),n=this.getAttribute("data-scroll-direction"),a=document.getElementsByClassName(t);Array.from(a).forEach(function(e){var t;t=e,0==n?t.scroll({left:t.scrollLeft-350,behavior:"smooth"}):t.scroll({left:t.scrollLeft+350,behavior:"smooth"})})})});var a=document.getElementsByClassName("js:ezy-addVariantButtons");Array.from(a).forEach(function(n){n.addEventListener("click",function(a){var i,r,c=this.getAttribute("data-variant-id");s("Product was added to the cart!"),t(n),i=function(){t(n)},r={items:[{id:c,quantity:1}]},e.productfeed.fetch("POST","/cart/add.js",r,"application/json; charset=utf-8",function(e){console.log(e),"function"==typeof i&&i()&&window.setTimeout(function(){i()},500)},function(e){"function"==typeof i&&i()&&window.setTimeout(function(){i()},500)}),"close"===o.closingBehav&&(m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3),""!=o.promoCode&&window.location.replace("https://"+ezshop+"/discount/"+o.promoCode))})});var i=document.getElementsByClassName("js:ezy-changeVariantSelects");Array.from(i).forEach(function(e){e.addEventListener("change",function(){var e=this.options[this.selectedIndex].getAttribute("data-variant-availability"),t=this.options[this.selectedIndex].getAttribute("data-variant-price"),n=this.options[this.selectedIndex].value,a=this.closest(".ezy-type-productfeed__item"),i=a.getElementsByClassName("js:ezy-addVariantButtons")[0];i.setAttribute("data-variant-id",n),a.getElementsByClassName("js:ezy-productPrice")[0].innerHTML=t,"true"==e?function(e){e.classList.remove("ezy-btn--disabled"),e.disabled=!1}(i):function(e){e.classList.add("ezy-btn--disabled"),e.disabled=!0}(i)});var t=new Event("change");e.dispatchEvent(t)});var s=function(e){var t=document.createElement("div");t.classList.add("ezy","ezy-notification"),u.appendChild(t),t.innerHTML=e,t.classList.add("ezy-notification--animate"),setTimeout(function(){t.classList.remove("ezy-notification--animate")},3e3)}}},e.productfeed.init()}var a;console.log("setting content types"),o.selectedProducts[0]&&(a=o.selectedProducts[0].selection),"modal"===i.campaignType?(m.classList.add("ezy","ezy-style-modal","open"),m.innerHTML=""+modal_1.modalTemplate(i,o,n,a,t),u.appendChild(m),e()):"full-screen"===i.campaignType?(m.classList.add("ezy","ezy-style-fullscreen","open"),m.style.backgroundColor=i.backgroundColor,m.innerHTML=""+fullscreen_1.fullscreenTemplate(i,o,n,a,t),u.appendChild(m),e()):"message-box"===i.campaignType?(m.classList.add("ezy","ezy-style-box","ezy-style-box--"+i.placementMB,"open"),m.innerHTML=""+box_1.boxTemplate(i,o,n,a,t),u.appendChild(m),e()):"slide-in"===i.campaignType&&(m.classList.add("ezy","ezy-style-drawer","ezy-style-drawer--"+i.placement,"open"),m.innerHTML=""+drawer_1.drawerTemplate(i,o,n,a,t),u.appendChild(m),e())};!function(){console.log("settings");var e=function(){console.log("we are auto-closed"),s.autoClose&&setTimeout(function(){m.classList.remove("open"),"slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):"message-box"===i.campaignType?m.classList.add("ezy-style-box--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3)},1e3*s.autoCloseTime)};s.frequency||(localStorage.removeItem("campaign_"+r),localStorage.removeItem("limit_"+r));var n=function(e){console.log("we are handling frequency"),Date.prototype.addDays=function(e){var t=new Date(this.valueOf());return t.setDate(t.getDate()+e),t};var t=parseInt(s.frequencyPeriod);if(new Date(c).addDays(t)<=new Date&&(localStorage.removeItem("limit_"+e),localStorage.removeItem("campaign_"+e)),s.frequency)if(localStorage.getItem("campaign_"+e)){if(n=localStorage.getItem("campaign_"+e),localStorage.getItem("limit_"+e))return;n++,localStorage.setItem("campaign_"+e,n),s.frequency&&parseInt(n)>=parseInt(s.frequencyTime)?(console.log("Limit is reached"),localStorage.setItem("limit_"+e,"true")):s.frequency&&parseInt(n)<parseInt(s.frequencyTime)?console.log("Limit not reached yet"):console.log("Frequency is off")}else{var n;localStorage.setItem("campaign_"+e,"1"),(n=localStorage.getItem("campaign_"+e))&&s.frequency&&parseInt(n)>=parseInt(s.frequencyTime)?(console.log("Limit is reached"),localStorage.setItem("limit_"+e,"true")):n&&s.frequency&&parseInt(n)<parseInt(s.frequencyTime)?console.log("Limit not reached yet"):console.log("Frequency is off")}},a=!1;new ClassWatcher(m,"open",function(){n(r),e(),a||(a=!0)},function(){});var u=function(e){var n,s,c=!1,d=!1,u=!1,p=!1,y=function(e){if("url"===e.triggerType){if("contains"===e.matchingFormat){if(window.location.href.includes(e.matchingInput))return"url"===e.triggerType}else if("matches"===e.matchingFormat&&window.location.href===e.matchingInput)return"url"===e.triggerType}else if("cart-size"===e.triggerType){if("greater"===e.matchingFormat){if(t.item_count>e.matchingInput)return"cart-size"===e.triggerType}else if("less"===e.matchingFormat&&t.item_count<e.matchingInput)return"cart-size"===e.triggerType}else if("cart-value"===e.triggerType){if("greater"===e.matchingFormat){if(t.total_price/100>e.matchingInput)return"cart-value"===e.triggerType}else if("less"===e.matchingFormat&&t.total_price/100<e.matchingInput)return"cart-value"===e.triggerType}else if("product-in-cart"===e.triggerType){if("contains"===e.matchingFormat){if(null!=t.items.find(function(t){return t.title.includes(e.matchingInput)}))return"product-in-cart"===e.triggerType}else if("matches"===e.matchingFormat&&null!=t.items.find(function(t){return t.title===e.matchingInput}))return"product-in-cart"===e.triggerType}else{if(u)return"scroll-depth"===e.triggerType;if("time-on-page"===e.triggerType){if(c)return"time-on-page"===e.triggerType}else if("exit-intent"===e.triggerType&&d)return"exit-intent"===e.triggerType}},g=function(e){var t=e,n='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])',a=t.querySelectorAll(n)[0],i=t.querySelectorAll(n),o=i[i.length-1];document.addEventListener("keydown",function(e){("Tab"===e.key||9===e.keyCode)&&(e.shiftKey?document.activeElement===a&&(o.focus(),e.preventDefault()):document.activeElement===o&&(a.focus(),e.preventDefault()))})};function h(){var t;console.log("checked"),"all"===e?t=l.every(y):"any"===e&&(t=l.some(y));var n=l.find(function(e){return"time-on-page"===e.triggerType});if(n&&!c&&setTimeout(function(){c=!0,h()},n?1e3*n.matchingInput:void 0),t&&!p&&!a&&!localStorage.getItem("limit_"+r)){console.log("conditions matched"),f(),"slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):"message-box"===i.campaignType?m.classList.add("ezy-style-box--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){"slide-in"===i.campaignType?m.classList.remove("ezy-style-drawer--animate"):"message-box"===i.campaignType?m.classList.remove("ezy-style-box--animate"):m.classList.remove("ezy-style-modal--animate")},10);for(var s=document.getElementsByClassName("closeBtn"),d=0;d<s.length;d++)s[d].addEventListener("click",function(e){"slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):"message-box"===i.campaignType?m.classList.add("ezy-style-box--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3)}),s[d].addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),"slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):"message-box"===i.campaignType?m.classList.add("ezy-style-box--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3))});var u=document.querySelector(".main-btn");o.buttonClose&&null!=u&&(u.addEventListener("click",function(e){e.preventDefault(),"slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):"message-box"===i.campaignType?m.classList.add("ezy-style-box--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3)}),u.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),"slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3))})),m.addEventListener("click",function(e){e.target==this&&("slide-in"===i.campaignType?m.classList.add("ezy-style-drawer--animate"):m.classList.add("ezy-style-modal--animate"),setTimeout(function(){m.classList.add("tw-hidden")},1e3))}),g(m),l.some(function(e){return"scroll-depth"===e.triggerType})&&(p=!0),document.removeEventListener("mouseout",b)}}h(),n=window,"function"==typeof(s=window.fetch)&&(n.fetch=function(){var e=s.apply(this,arguments);return e.then(function(e){[window.location.origin+"/cart/add.js",window.location.origin+"/cart/update.js",window.location.origin+"/cart/change.js",window.location.origin+"/cart/clear.js"].includes(e.url)&&e.clone().json().then(function(e){fetchCartInfo().then(function(e){t=e,h()})})}),e});var v=window.XMLHttpRequest.prototype.open;window.XMLHttpRequest.prototype.open=function(){return this.addEventListener("load",function(){["/cart/add.js","/cart/update.js","/cart/change.js","/cart/clear.js"].includes(this._url)&&fetchCartInfo().then(function(e){t=e,h()})}),v.apply(this,arguments)};var b=function(e){!e.toElement&&!e.relatedTarget&&e.clientY<10&&(d=!0,h())};l.some(function(e){return"exit-intent"===e.triggerType})&&document.addEventListener("mouseout",b);var w=function(){var e=window.scrollY,t=l.find(function(e){return"scroll-depth"===e.triggerType});!u&&t?(e>=t.matchingInput&&(console.log("found"),u=!0,h()),console.log("catching")):(console.log("remove listener"),document.removeEventListener("scroll",w))};l.some(function(e){return"scroll-depth"===e.triggerType})&&document.addEventListener("scroll",w)};"all"===d?(console.log("all triggers are matched"),u("all")):"any"===d&&(console.log("any triggers are matched"),u("any"))}()}}}),[3,4];case 3:return n=a.sent(),console.log(n),[3,4];case 4:return[2]}})})}campaignInfo();