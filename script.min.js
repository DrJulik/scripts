"use strict";var _a,__awaiter=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))(function(i,s){function o(e){try{c(a.next(e))}catch(e){s(e)}}function r(e){try{c(a.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,r)}c((a=a.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,a,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,a&&(i=2&s[0]?a.return:s[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,s[1])).done)return i;switch(a=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],a=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}};Object.defineProperty(exports,"__esModule",{value:!0}),require("regenerator-runtime/runtime");var modal_1=require("./templates/style/modal"),fullscreen_1=require("./templates/style/fullscreen"),box_1=require("./templates/style/box"),drawer_1=require("./templates/style/drawer"),ezshop=null===(_a=window.location.href.split("https://").pop())||void 0===_a?void 0:_a.split("/")[0],fetchCampaignInfo=function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("https://easypop.herokuapp.com/api/campaigns/"+ezshop,{method:"GET",headers:{"Content-Type":"application/json"}})];case 1:return[4,e.sent().json()];case 2:return[2,e.sent().data]}})})},fetchCartInfo=function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("/cart.js",{method:"GET",headers:{"Content-Type":"application/json"}})];case 1:return[4,e.sent().json()];case 2:return[2,e.sent()]}})})},ClassWatcher=function(){function e(e,t,n,a){var i=this;this.mutationCallback=function(e){for(var t=0,n=e;t<n.length;t++){var a=n[t];if("attributes"===a.type&&"class"===a.attributeName){var s=a.target.classList.contains(i.classToWatch);i.lastClassState!==s&&(i.lastClassState=s,s?i.classAddedCallback():i.classRemovedCallback())}}},this.targetNode=e,this.classToWatch=t,this.classAddedCallback=n,this.classRemovedCallback=a,this.observer=null,this.lastClassState=e.classList.contains(this.classToWatch),this.init()}return e.prototype.init=function(){this.observer=new MutationObserver(this.mutationCallback),this.observe()},e.prototype.observe=function(){this.observer.observe(this.targetNode,{attributes:!0})},e.prototype.disconnect=function(){this.observer.disconnect()},e}(),campaignInfo=function(){return __awaiter(void 0,void 0,void 0,function(){var e,t,n;return __generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,3,,4]),[4,fetchCampaignInfo()];case 1:return e=a.sent(),[4,fetchCartInfo()];case 2:return t=a.sent(),console.log(t),e.forEach(function(e){console.log(e);var n=e.freePlan,a=e.style,i=e.content,s=e.settings,o=e._id,r=e.createdAt,c=s.triggers,l=s.triggerMatch,d=document.querySelector("body"),u=document.createElement("section"),m=document.createElement("link");m.rel="stylesheet",m.href="https://cdn.jsdelivr.net/gh/DrJulik/scripts@1.0.947429/styles.min.css",document.head.appendChild(m);var f=function(){var e;console.log("setting content types"),i.selectedProducts[0]&&(e=i.selectedProducts[0].selection),"modal"===a.campaignType?(u.classList.add("ezy","ezy-style-modal","open"),u.innerHTML=""+modal_1.modalTemplate(a,i,n,e,t),d.appendChild(u),p()):"full-screen"===a.campaignType?(u.classList.add("ezy","ezy-style-fullscreen","open"),u.style.backgroundColor=a.backgroundColor,u.innerHTML=""+fullscreen_1.fullscreenTemplate(a,i,n,e,t),d.appendChild(u),p()):"message-box"===a.campaignType?(u.classList.add("ezy","ezy-style-box","ezy-style-box--"+a.placementMB,"open"),u.innerHTML=""+box_1.boxTemplate(a,i,n,e,t),d.appendChild(u),p()):"slide-in"===a.campaignType&&(u.classList.add("ezy","ezy-style-drawer","ezy-style-drawer--"+a.placement,"open"),u.innerHTML=""+drawer_1.drawerTemplate(a,i,n,e,t),d.appendChild(u),p())};function p(){console.log("productfeedset");var e=e||{};e.productfeed={fetch:function(e,t,n,a,i,s){fetch(t,{method:e,headers:{"Content-Type":a,Accept:a,"X-Requested-With":"xmlhttprequest"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){i(e)}).catch(function(e){s(e)})},init:function(){function t(e){e.classList.contains("ezy-btn--loading")?(e.classList.remove("ezy-btn--loading"),e.disabled=!1):(e.classList.add("ezy-btn--loading"),e.disabled=!0)}var n=document.getElementsByClassName("js:ezy-scrollArrowButtons");Array.from(n).forEach(function(e){e.addEventListener("click",function(e){var t=this.getAttribute("data-scroll-container"),n=this.getAttribute("data-scroll-direction"),a=document.getElementsByClassName(t);Array.from(a).forEach(function(e){var t;t=e,0==n?t.scroll({left:t.scrollLeft-350,behavior:"smooth"}):t.scroll({left:t.scrollLeft+350,behavior:"smooth"})})})});var a=document.getElementsByClassName("js:ezy-addVariantButtons");Array.from(a).forEach(function(n){n.addEventListener("click",function(a){var s,r,c=this.getAttribute("data-variant-id");o("Product was added to the cart!"),t(n),s=function(){t(n)},r={items:[{id:c,quantity:1}]},e.productfeed.fetch("POST","/cart/add.js",r,"application/json; charset=utf-8",function(e){console.log(e),"function"==typeof s&&s()&&window.setTimeout(function(){s()},500)},function(e){"function"==typeof s&&s()&&window.setTimeout(function(){s()},500)}),"close"===i.closingBehav&&(u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3))})});var s=document.getElementsByClassName("js:ezy-changeVariantSelects");Array.from(s).forEach(function(e){e.addEventListener("change",function(){var e=this.options[this.selectedIndex].getAttribute("data-variant-availability"),t=this.options[this.selectedIndex].getAttribute("data-variant-price"),n=this.options[this.selectedIndex].value,a=this.closest(".ezy-type-productfeed__item"),i=a.getElementsByClassName("js:ezy-addVariantButtons")[0];i.setAttribute("data-variant-id",n),a.getElementsByClassName("js:ezy-productPrice")[0].innerHTML=t,"true"==e?function(e){e.classList.remove("ezy-btn--disabled"),e.disabled=!1}(i):function(e){e.classList.add("ezy-btn--disabled"),e.disabled=!0}(i)});var t=new Event("change");e.dispatchEvent(t)});var o=function(e){var t=document.createElement("div");t.classList.add("ezy","ezy-notification"),d.appendChild(t),t.innerHTML=e,t.classList.add("ezy-notification--animate"),setTimeout(function(){t.classList.remove("ezy-notification--animate")},3e3)}}},e.productfeed.init()}!function(){console.log("settings");var e=function(){console.log("we are auto-closed"),s.autoClose&&setTimeout(function(){u.classList.remove("open"),"slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):"message-box"===a.campaignType?u.classList.add("ezy-style-box--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3)},1e3*s.autoCloseTime)};s.frequency||(localStorage.removeItem("campaign_"+o),localStorage.removeItem("limit_"+o));var n=function(e){console.log("we are handling frequency"),Date.prototype.addDays=function(e){var t=new Date(this.valueOf());return t.setDate(t.getDate()+e),t};var t=parseInt(s.frequencyPeriod);if(new Date(r).addDays(t)<=new Date&&(localStorage.removeItem("limit_"+e),localStorage.removeItem("campaign_"+e)),s.frequency)if(localStorage.getItem("campaign_"+e)){if(n=localStorage.getItem("campaign_"+e),localStorage.getItem("limit_"+e))return;n++,localStorage.setItem("campaign_"+e,n),s.frequency&&parseInt(n)>=parseInt(s.frequencyTime)?(console.log("Limit is reached"),localStorage.setItem("limit_"+e,"true")):s.frequency&&parseInt(n)<parseInt(s.frequencyTime)?console.log("Limit not reached yet"):console.log("Frequency is off")}else{var n;localStorage.setItem("campaign_"+e,"1"),(n=localStorage.getItem("campaign_"+e))&&s.frequency&&parseInt(n)>=parseInt(s.frequencyTime)?(console.log("Limit is reached"),localStorage.setItem("limit_"+e,"true")):n&&s.frequency&&parseInt(n)<parseInt(s.frequencyTime)?console.log("Limit not reached yet"):console.log("Frequency is off")}},d=!1;new ClassWatcher(u,"open",function(){n(o),e(),d||(d=!0)},function(){});var m=function(e){var n,s,r=!1,l=!1,m=!1,p=!1,y=function(e){if("url"===e.triggerType){if("contains"===e.matchingFormat){if(window.location.href.includes(e.matchingInput))return"url"===e.triggerType}else if("matches"===e.matchingFormat&&window.location.href===e.matchingInput)return"url"===e.triggerType}else if("cart-size"===e.triggerType){if("greater"===e.matchingFormat){if(t.item_count>e.matchingInput)return"cart-size"===e.triggerType}else if("less"===e.matchingFormat&&t.item_count<e.matchingInput)return"cart-size"===e.triggerType}else if("cart-value"===e.triggerType){if("greater"===e.matchingFormat){if(t.total_price/100>e.matchingInput)return"cart-value"===e.triggerType}else if("less"===e.matchingFormat&&t.total_price/100<e.matchingInput)return"cart-value"===e.triggerType}else if("product-in-cart"===e.triggerType){if("contains"===e.matchingFormat){if(null!=t.items.find(function(t){return t.title.includes(e.matchingInput)}))return"product-in-cart"===e.triggerType}else if("matches"===e.matchingFormat&&null!=t.items.find(function(t){return t.title===e.matchingInput}))return"product-in-cart"===e.triggerType}else{if(m)return"scroll-depth"===e.triggerType;if("time-on-page"===e.triggerType){if(r)return"time-on-page"===e.triggerType}else if("exit-intent"===e.triggerType&&l)return"exit-intent"===e.triggerType}},g=function(e){var t=e,n='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])',a=t.querySelectorAll(n)[0],i=t.querySelectorAll(n),s=i[i.length-1];document.addEventListener("keydown",function(e){("Tab"===e.key||9===e.keyCode)&&(e.shiftKey?document.activeElement===a&&(s.focus(),e.preventDefault()):document.activeElement===s&&(a.focus(),e.preventDefault()))})};function h(){var t;console.log("checked"),"all"===e?t=c.every(y):"any"===e&&(t=c.some(y));var n=c.find(function(e){return"time-on-page"===e.triggerType});if(n&&!r&&setTimeout(function(){r=!0,h()},n?1e3*n.matchingInput:void 0),t&&!p&&!d&&!localStorage.getItem("limit_"+o)){console.log("conditions matched"),f(),"slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):"message-box"===a.campaignType?u.classList.add("ezy-style-box--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){"slide-in"===a.campaignType?u.classList.remove("ezy-style-drawer--animate"):"message-box"===a.campaignType?u.classList.remove("ezy-style-box--animate"):u.classList.remove("ezy-style-modal--animate")},100);for(var s=document.getElementsByClassName("closeBtn"),l=0;l<s.length;l++)s[l].addEventListener("click",function(e){"slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):"message-box"===a.campaignType?u.classList.add("ezy-style-box--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3)}),s[l].addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),"slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):"message-box"===a.campaignType?u.classList.add("ezy-style-box--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3))});var m=document.querySelector(".main-btn");i.buttonClose&&null!=m&&(m.addEventListener("click",function(e){e.preventDefault(),"slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):"message-box"===a.campaignType?u.classList.add("ezy-style-box--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3)}),m.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),"slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3))})),u.addEventListener("click",function(e){e.target==this&&("slide-in"===a.campaignType?u.classList.add("ezy-style-drawer--animate"):u.classList.add("ezy-style-modal--animate"),setTimeout(function(){u.classList.add("tw-hidden")},1e3))}),g(u),c.some(function(e){return"scroll-depth"===e.triggerType})&&(p=!0),document.removeEventListener("mouseout",b)}}h(),n=window,"function"==typeof(s=window.fetch)&&(n.fetch=function(){var e=s.apply(this,arguments);return e.then(function(e){[window.location.origin+"/cart/add.js",window.location.origin+"/cart/update.js",window.location.origin+"/cart/change.js",window.location.origin+"/cart/clear.js"].includes(e.url)&&e.clone().json().then(function(e){fetchCartInfo().then(function(e){t=e,h()})})}),e});var v=window.XMLHttpRequest.prototype.open;window.XMLHttpRequest.prototype.open=function(){return this.addEventListener("load",function(){["/cart/add.js","/cart/update.js","/cart/change.js","/cart/clear.js"].includes(this._url)&&fetchCartInfo().then(function(e){t=e,h()})}),v.apply(this,arguments)};var b=function(e){!e.toElement&&!e.relatedTarget&&e.clientY<10&&(l=!0,h())};c.some(function(e){return"exit-intent"===e.triggerType})&&document.addEventListener("mouseout",b);var T=function(){var e=window.scrollY,t=c.find(function(e){return"scroll-depth"===e.triggerType});!m&&t?(e>=t.matchingInput&&(console.log("found"),m=!0,h()),console.log("catching")):(console.log("remove listener"),document.removeEventListener("scroll",T))};c.some(function(e){return"scroll-depth"===e.triggerType})&&document.addEventListener("scroll",T)};"all"===l?(console.log("all triggers are matched"),m("all")):"any"===l&&(console.log("any triggers are matched"),m("any"))}()}),[3,4];case 3:return n=a.sent(),console.log(n),[3,4];case 4:return[2]}})})};campaignInfo();